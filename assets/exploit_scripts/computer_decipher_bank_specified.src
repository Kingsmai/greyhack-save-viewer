cryptools = include_lib("/lib/crypto.so")
if not cryptools then
	cryptools = include_lib(current_path + "/crypto.so")
end if
if not cryptools then exit("Error: Can't find crypto.so library in the /lib path or the current folder")

GetPassword = function(userPass)
	if userPass.len != 2 then exit("decipher: wrong syntax")
	password = cryptools.decipher(userPass[1])
	return password
end function

typeObject = typeof(result)
if(typeObject != "computer") then exit("Error: expected computer, obtained " + typeObject)
homeFolder = result.File("/home")
if not homeFolder then exit("Error: /home folder not found")
userFolders = homeFolder.get_folders
targetFolder = userFolders[0]
found = false

if userFolders.len > 2 then
	print("Multiple users found.")
	numLine = 1
	for userFolder in userFolders
		if userFolder.name == "guest" then
			print("Skipping guest user")
		else
			print(numLine + ": " + userFolder.name)
		end if
		numLine = numLine + 1
	end for
	option = ""
	inputOk = false
	while( not inputOk )
		option = user_input("Select user: ").to_int
		if typeof(option) != "number" or (option < 1 or option > userFolders.len - 1) then
			print("Invalid input. Type a valid number")
		else 
			inputOk = true
		end if
	end while

	targetFolder = userFolders[option - 1]
else if userFolders.len == 2 then
	// Only one user found, except guest
	for userFolder in userFolders
		if userFolder.name != "guest" then
			targetFolder = userFolder
			break
		end if
	end for
	if targetFolder.name == "guest" then
		exit("Error: no users found in /home folder, only guest user")
	else
		print("Only one user found: " + targetFolder.name)
	end if
else
	// No users found
	exit("Error: no users found in /home folder")
end if

bankFile = result.File("/home/" + targetFolder.name + "/Config/Bank.txt")
if not bankFile then exit("Error: can't find Bank.txt file for user " + targetFolder.name)
if not bankFile.has_permission("r") then exit("Error: can't read file contents. Permission denied")
userPass = bankFile.get_content.split(":")
print("Deciphering bank password for user: " + targetFolder.name)
password = GetPassword(userPass)
if not password then 
	print("Nothing found...")
else
	print("Bank account: " + userPass[0] +"\nBank Password: " + password)
	found = true
end if
if not found then print("No files found")
